define(["layout/module","jquery"],function(a,b){"use strict";b.root_=b("body");var c=window;if(appConfig.voice_command)var d=appConfig.commands;var e=c.SpeechRecognition||c.webkitSpeechRecognition||c.mozSpeechRecognition||c.msSpeechRecognition||c.oSpeechRecognition;b.speechApp=function(a){return a.start=function(){smartSpeechRecognition.addCommands(d),smartSpeechRecognition?(smartSpeechRecognition.start(),b.root_.addClass("voice-command-active"),b.speechApp.playON(),appConfig.voice_localStorage&&localStorage.setItem("sm-setautovoice","true")):alert("speech plugin not loaded")},a.stop=function(){smartSpeechRecognition&&(smartSpeechRecognition.abort(),b.root_.removeClass("voice-command-active"),b.speechApp.playOFF(),appConfig.voice_localStorage&&localStorage.setItem("sm-setautovoice","false"),b("#speech-btn .popover").is(":visible")&&b("#speech-btn .popover").fadeOut(250))},a.playON=function(){var a=document.createElement("audio");navigator.userAgent.match("Firefox/")?a.setAttribute("src",appConfig.sound_path+"voice_on.ogg"):a.setAttribute("src",appConfig.sound_path+"voice_on.mp3"),a.addEventListener("load",function(){a.play()},!0),appConfig.sound_on&&(a.pause(),a.play())},a.playOFF=function(){var a=document.createElement("audio");navigator.userAgent.match("Firefox/")?a.setAttribute("src",appConfig.sound_path+"voice_off.ogg"):a.setAttribute("src",appConfig.sound_path+"voice_off.mp3"),b.get(),a.addEventListener("load",function(){a.play()},!0),appConfig.sound_on&&(a.pause(),a.play())},a.playConfirmation=function(){var a=document.createElement("audio");navigator.userAgent.match("Firefox/")?a.setAttribute("src",appConfig.sound_path+"voice_alert.ogg"):a.setAttribute("src",appConfig.sound_path+"voice_alert.mp3"),b.get(),a.addEventListener("load",function(){a.play()},!0),appConfig.sound_on&&(a.pause(),a.play())},a}({}),function(a){if(!e)return c.smartSpeechRecognition=null,a;var d,f,g=[],h={start:[],error:[],end:[],result:[],resultMatch:[],resultNoMatch:[],errorNetwork:[],errorPermissionBlocked:[],errorPermissionDenied:[]},i=0,j=/\s*\((.*?)\)\s*/g,k=/(\(\?:[^)]+\))\?/g,l=/(\(\?)?:\w+/g,m=/\*\w+/g,n=/[\-{}\[\]+?.,\\\^$|#]/g,o=function(a){return a=a.replace(n,"\\$&").replace(j,"(?:$1)?").replace(l,function(a,b){return b?a:"([^\\s]+)"}).replace(m,"(.*?)").replace(k,"\\s*$1?\\s*"),new RegExp("^"+a+"$","i")},p=function(a){a.forEach(function(a){a.callback.apply(a.context)})},q=function(){r()||c.smartSpeechRecognition.init({},!1)},r=function(){return d!==a};c.smartSpeechRecognition={init:function(j,k){k=k===a?!0:!!k,d&&d.abort&&d.abort(),d=new e,d.maxAlternatives=5,d.continuous=!0,d.lang=appConfig.voice_command_lang||"en-US",d.onstart=function(){p(h.start),appConfig.debugState&&(c.console.log("%c âœ” SUCCESS: User allowed access the microphone service to start ",appConfig.debugStyle_success),c.console.log("Language setting is set to: "+d.lang,appConfig.debugStyle)),b.root_.removeClass("service-not-allowed"),b.root_.addClass("service-allowed")},d.onerror=function(a){switch(p(h.error),a.error){case"network":p(h.errorNetwork);break;case"not-allowed":case"service-not-allowed":f=!1,b.root_.removeClass("service-allowed"),b.root_.addClass("service-not-allowed"),appConfig.debugState&&c.console.log("%c WARNING: Microphone was not detected (either user denied access or it is not installed properly) ",appConfig.debugStyle_warning),p((new Date).getTime()-i<200?h.errorPermissionBlocked:h.errorPermissionDenied)}},d.onend=function(){if(p(h.end),f){var a=(new Date).getTime()-i;1e3>a?setTimeout(c.smartSpeechRecognition.start,1e3-a):c.smartSpeechRecognition.start()}},d.onresult=function(a){p(h.result);for(var d,e=a.results[a.resultIndex],f=0;f<e.length;f++){d=e[f].transcript.trim(),appConfig.debugState&&c.console.log("Speech recognized: %c"+d,appConfig.debugStyle);for(var i=0,j=g.length;j>i;i++){var k=g[i].command.exec(d);if(k){var l=k.slice(1);appConfig.debugState&&(c.console.log("command matched: %c"+g[i].originalPhrase,appConfig.debugStyle),l.length&&c.console.log("with parameters",l)),g[i].callback.apply(this,l),p(h.resultMatch);var m=["sound on","mute","stop"];return m.indexOf(g[i].originalPhrase)<0&&(console.log(2),b.smallBox({title:g[i].originalPhrase,content:"loading...",color:"#333",sound_file:"voice_alert",timeout:2e3}),b("#speech-btn .popover").is(":visible")&&b("#speech-btn .popover").fadeOut(250)),!0}}}return p(h.resultNoMatch),b.smallBox({title:'Error: <strong> " '+d+' " </strong> no match found!',content:"Please speak clearly into the microphone",color:"#a90329",timeout:5e3,icon:"fa fa-microphone"}),b("#speech-btn .popover").is(":visible")&&b("#speech-btn .popover").fadeOut(250),!1},k&&(g=[]),j.length&&this.addCommands(j)},start:function(b){q(),b=b||{},f=b.autoRestart!==a?!!b.autoRestart:!0,i=(new Date).getTime(),d.start()},abort:function(){f=!1,r&&d.abort()},debug:function(a){appConfig.debugState=arguments.length>0?!!a:!0},setLanguage:function(a){q(),d.lang=a},addCommands:function(a){var b,d;q();for(var e in a)if(a.hasOwnProperty(e)){if(b=c[a[e]]||a[e],"function"!=typeof b)continue;d=o(e),g.push({command:d,callback:b,originalPhrase:e})}appConfig.debugState&&c.console.log("Commands successfully loaded: %c"+g.length,appConfig.debugStyle)},removeCommands:function(b){return b===a?void(g=[]):(b=Array.isArray(b)?b:[b],void(g=g.filter(function(a){for(var c=0;c<b.length;c++)if(b[c]===a.originalPhrase)return!1;return!0})))},addCallback:function(b,d,e){if(h[b]!==a){var f=c[d]||d;"function"==typeof f&&h[b].push({callback:f,context:e||this})}}}}.call(this);var f=function(){smartSpeechRecognition.addCommands(d),smartSpeechRecognition?(smartSpeechRecognition.start(),b.root_.addClass("voice-command-active"),appConfig.voice_localStorage&&localStorage.setItem("sm-setautovoice","true")):alert("speech plugin not loaded")};e&&appConfig.voice_command&&"true"==localStorage.getItem("sm-setautovoice")&&f(),e&&appConfig.voice_command_auto&&appConfig.voice_command&&f(),a.registerDirective("speechRecognition",["$log",function(){var a=function(a,c){if(e&&appConfig.voice_command){var f=b('<div class="modal fade" id="voiceModal" tabindex="-1" role="dialog" aria-labelledby="remoteModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"></div></div></div>');f.appendTo("body"),c.on("click",function(a){b.root_.hasClass("voice-command-active")?b.speechApp.stop():(b.speechApp.start(),b("#speech-btn .popover").fadeIn(350)),a.preventDefault()}),b(document).mouseup(function(a){b("#speech-btn .popover").is(a.target)||0!==b("#speech-btn .popover").has(a.target).length||b("#speech-btn .popover").fadeOut(250)}),b("#speech-help-btn").on("click",function(){d.help()})}else b("#speech-btn").addClass("display-none")};return{restrict:"AE",link:a}}])});